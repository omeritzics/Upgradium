name: Build and Release Qama (without signing)

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: false
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Run Environment Sync
        run: |
          if [ -f "scripts/fix_environment.sh" ]; then
            chmod +x scripts/fix_environment.sh
            ./scripts/fix_environment.sh
          else
            echo "Sync script not found, skipping..."
          fi

      - name: Set App Name and Build APK
        run: |
          # 1. הסרת הסיומת "debug" משם האפליקציה ב-Manifest
          sed -i 's/android:label=".*"/android:label="Updatium"/g' android/app/src/main/AndroidManifest.xml
          
          # 2. הסרת הגדרות חתימה כדי למנוע שגיאות ב-Build ללא Keystore
          sed -i 's/signingConfig = signingConfigs.getByName("release")//g' android/app/build.gradle* || true
          
          # 3. בניית ה-APK:
          # build-name: הגרסה שתוצג באפליקציה (26.1)
          # build-number: המספר הפנימי שעולה בכל הרצה ומאפשר התקנת עדכון
          flutter build apk --debug --flavor normal \
            --build-name="26.1" \
            --build-number="${{ github.run_number }}"
          

          mkdir -p build/outputs/
          cp build/app/outputs/flutter-apk/app-normal-debug.apk build/outputs/updatium-qama-v26.1-run${{ github.run_number }}.apk

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Updatium-Qama-v26.1-run${{ github.run_number }}
          path: build/outputs/updatium-qama-v26.1-run${{ github.run_number }}.apk

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: qama-v26.1-run${{ github.run_number }}
          name: "Updatium Qama v26.1 (Run ${{ github.run_number }})"
          files: build/outputs/updatium-qama-v26.1-run${{ github.run_number }}.apk
          prerelease: true
          draft: true
          body: "This is an automated build of Updatium Qama. Version: 26.1 (Build ${{ github.run_number }})"
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
